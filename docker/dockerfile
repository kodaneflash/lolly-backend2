# √âtape 1 : Image de base avec Node.js 18
FROM node:18-slim

# √âtape 2 : Installer curl, gnupg, dash (shell), ffmpeg, unzip, wget, yarn
RUN apt-get update && apt-get install -y \
  curl \
  gnupg \
  dash \
  ffmpeg \
  unzip \
  wget \
  && curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add - \
  && echo "deb https://dl.yarnpkg.com/debian stable main" > /etc/apt/sources.list.d/yarn.list \
  && apt-get update && apt-get install -y yarn \
  && rm -rf /var/lib/apt/lists/*

# √âtape 3 : Ajouter ffmpeg et yarn au PATH (pr√©caution)
ENV PATH="/usr/bin:/usr/local/bin:${PATH}"

# √âtape 4 : V√©rification des versions
RUN ffmpeg -version && yarn --version

# √âtape 5 : T√©l√©charger et installer Rhubarb Lip Sync 1.14.0
RUN mkdir -p /rhubarb && \
    wget https://github.com/DanielSWolf/rhubarb-lip-sync/releases/download/v1.14.0/Rhubarb-Lip-Sync-1.14.0-Linux.zip -O rhubarb.zip && \
    unzip rhubarb.zip -d /rhubarb && \
    mv /rhubarb/Rhubarb-Lip-Sync-1.14.0-Linux/rhubarb /usr/local/bin/rhubarb && \
    chmod +x /usr/local/bin/rhubarb && \
    rm -rf rhubarb.zip /rhubarb

# üîç V√©rification pr√©sence de Rhubarb (optionnel mais utile en dev)
RUN ls -l /usr/local/bin/rhubarb

# √âtape 6 : R√©pertoire de travail
WORKDIR /app

# √âtape 7 : Cr√©er le dossier audio (pr√©vention)
RUN mkdir -p /app/audios

# √âtape 8 : Copier les fichiers
COPY . .

# √âtape 9 : Installer les d√©pendances
RUN yarn install --frozen-lockfile

# √âtape 10 : D√©finir l'environnement
ENV NODE_ENV=production

# √âtape 11 : Exposer le port
EXPOSE 3000

# √âtape 12 : D√©marrage de l‚Äôapplication
CMD ["node", "index.js"]
