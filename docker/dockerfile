# Étape 1 : Image de base avec Node.js 18
FROM node:18-slim

# Étape 2 : Installer curl, gnupg et dash (pour shell)
RUN apt-get update && apt-get install -y \
  curl \
  gnupg \
  dash

# Étape 3 : Installer Yarn
RUN curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add - && \
  echo "deb https://dl.yarnpkg.com/debian stable main" > /etc/apt/sources.list.d/yarn.list

# Étape 4 : Installer ffmpeg, unzip, wget, yarn
RUN apt-get update && apt-get install -y \
  ffmpeg \
  unzip \
  wget \
  yarn && \
  rm -rf /var/lib/apt/lists/*

# Étape 5 : Ajouter ffmpeg et yarn au PATH
ENV PATH="/usr/bin:${PATH}"

# Étape 6 : Vérification des versions
RUN ffmpeg -version && yarn --version

# Étape 7 : Télécharger et installer Rhubarb Lip Sync 1.14.0
RUN mkdir -p /rhubarb && \
    wget https://github.com/DanielSWolf/rhubarb-lip-sync/releases/download/v1.14.0/Rhubarb-Lip-Sync-1.14.0-Linux.zip -O rhubarb.zip && \
    unzip rhubarb.zip -d /rhubarb && \
    mv /rhubarb/Rhubarb-Lip-Sync-1.14.0-Linux/rhubarb /usr/local/bin/rhubarb && \
    chmod +x /usr/local/bin/rhubarb && \
    rm -rf rhubarb.zip /rhubarb

# Étape 8 : Répertoire de travail
WORKDIR /app

# Étape 9 : Copier les fichiers
COPY . .

# Étape 10 : Installer les dépendances
RUN yarn install --frozen-lockfile

# Étape 11 : Définir l'environnement
ENV NODE_ENV=production

# Étape 12 : Exposer le port
EXPOSE 3000

# Étape 13 : Commande de démarrage
CMD ["node", "index.js"]
